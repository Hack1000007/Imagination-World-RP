<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Imagination World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- Font Awesome CDN -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            padding: 2rem;
        }
        @media (min-width: 640px) {
            .container {
                max-width: 800px;
            }
        }
        /* Modal styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            animation: fadeInScale 0.3s ease-out forwards;
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 100%;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <div class="container bg-white shadow-xl rounded-lg p-6 md:p-8 mt-8 w-full">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Paramètres du Compte</h1>
        <p class="text-center text-gray-600 mb-8">Gérez vos préférences et informations de compte ici.</p>

        <div class="space-y-6">
            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-user-circle mr-2 text-blue-500"></i> Informations Personnelles
                </h2>
                <p class="text-gray-600">Mettez à jour votre nom, email ou numéro de téléphone.</p>
                <button id="editProfileButton" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">Modifier les infos</button>
            </div>

            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-lock mr-2 text-purple-500"></i> Changer le Mot de Passe
                </h2>
                <p class="text-gray-600">Définissez un nouveau mot de passe pour votre compte.</p>
                <button id="changePasswordButton" class="mt-4 bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 transition">Changer le mot de passe</button>
            </div>

            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-bell mr-2 text-green-500"></i> Préférences de Notification
                </h2>
                <p class="text-gray-600">Activez ou désactivez certains types de notifications.</p>
                <button id="manageNotificationsButton" class="mt-4 bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">Gérer les notifications</button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-trash-alt mr-2 text-red-500"></i> Supprimer le Compte
                </h2>
                <p class="text-gray-600">Supprimez définitivement votre compte et toutes les données associées.</p>
                <button id="deleteAccountButton" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">Supprimer le compte</button>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="index.html" class="inline-block bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-150 ease-in-out">
                Retour au Créateur de Personnages
            </a>
        </div>
    </div>

    <!-- Modals for Settings Operations -->

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="fixed inset-0 modal-overlay flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Modifier le Profil</h3>
            <form id="editProfileForm" class="space-y-4">
                <div>
                    <label for="editFirstName" class="block text-sm font-medium text-gray-700">Prénom:</label>
                    <input type="text" id="editFirstName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="editLastName" class="block text-sm font-medium text-gray-700">Nom:</label>
                    <input type="text" id="editLastName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="editUsername" class="block text-sm font-medium text-gray-700">Nom d'utilisateur:</label>
                    <input type="text" id="editUsername" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="editEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="editEmail" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" readonly disabled>
                    <p class="text-xs text-gray-500 mt-1">L'email ne peut pas être modifié ici.</p>
                </div>
                <div>
                    <label for="editPhone" class="block text-sm font-medium text-gray-700">Téléphone:</label>
                    <input type="tel" id="editPhone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelEditProfile" class="bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500">Annuler</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 modal-overlay flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Changer le Mot de Passe</h3>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="oldPassword" class="block text-sm font-medium text-gray-700">Ancien Mot de Passe:</label>
                    <input type="password" id="oldPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-700">Nouveau Mot de Passe:</label>
                    <input type="password" id="newPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">Confirmer Nouveau Mot de Passe:</label>
                    <input type="password" id="confirmNewPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelChangePassword" class="bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500">Annuler</button>
                    <button type="submit" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Changer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div id="deleteAccountModal" class="fixed inset-0 modal-overlay flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center modal-content">
            <h3 class="text-xl font-bold mb-4 text-red-600">Supprimer le Compte</h3>
            <p class="text-gray-700 mb-6">Êtes-vous sûr de vouloir supprimer votre compte définitivement ? Cette action est irréversible et toutes vos données de personnage seront perdues.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" id="cancelDeleteAccount" class="bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500">Annuler</button>
                <button type="button" id="confirmDeleteAccount" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Confirmer la Suppression</button>
            </div>
        </div>
    </div>

    <!-- Generic Message Modal (used by showMessage function) -->
    <div id="messageBox" class="fixed inset-0 modal-overlay flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center modal-content">
            <h3 id="messageTitle" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="messageContent" class="text-gray-700 mb-6 text-sm"></p>
            <button id="closeMessageBox" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Fermer</button>
        </div>
    </div>

    <script>
        // Firebase Client Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDux4S_lY_8mygOBeimpGXl5xeNI0HGeAA",
            authDomain: "imagination-f2e5c.firebaseapp.com",
            projectId: "imagination-f2e5c",
            storageBucket: "imagination-f2e5c.firebasestorage.app",
            messagingSenderId: "182206843362",
            appId: "1:182206843362:web:eda2dda1ef85a624a811bb",
            measurementId: "G-NK53DJQWH6"
        };

        let app;
        let auth;
        let db;

        // DOM elements
        const editProfileButton = document.getElementById('editProfileButton');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const deleteAccountButton = document.getElementById('deleteAccountButton');
        const manageNotificationsButton = document.getElementById('manageNotificationsButton'); // Added for completeness

        const editProfileModal = document.getElementById('editProfileModal');
        const editProfileForm = document.getElementById('editProfileForm');
        const editFirstName = document.getElementById('editFirstName');
        const editLastName = document.getElementById('editLastName');
        const editUsername = document.getElementById('editUsername');
        const editEmail = document.getElementById('editEmail');
        const editPhone = document.getElementById('editPhone');
        const cancelEditProfile = document.getElementById('cancelEditProfile');

        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const oldPassword = document.getElementById('oldPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmNewPassword = document.getElementById('confirmNewPassword');
        const cancelChangePassword = document.getElementById('cancelChangePassword');

        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const cancelDeleteAccount = document.getElementById('cancelDeleteAccount');
        const confirmDeleteAccount = document.getElementById('confirmDeleteAccount');

        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');
        const closeMessageBoxBtn = document.getElementById('closeMessageBox');

        let currentUserAccount = null; // To store user data from localStorage

        // Function to show a message modal
        function showMessage(title, content) {
            if (messageTitle) messageTitle.textContent = title;
            if (messageContent) messageContent.textContent = content;
            if (messageBox) messageBox.classList.remove('hidden');
            else console.error("Error: Could not display modal, missing or uninitialized elements.");
        }

        // Close generic message modal
        if (closeMessageBoxBtn) {
            closeMessageBoxBtn.addEventListener('click', () => {
                if (messageBox) messageBox.classList.add('hidden');
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();

            currentUserAccount = JSON.parse(localStorage.getItem('iwUserAccount'));

            if (!currentUserAccount || !currentUserAccount.userId) {
                showMessage("Non Connecté", "Veuillez vous connecter pour gérer vos paramètres de compte.");
                // Redirect to login or disable all buttons if not logged in
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                return;
            }

            // Populate Edit Profile fields initially (assuming backend data matches localStorage)
            // For a robust app, fetch fresh data from /api/users or Firestore
            try {
                const response = await fetch(`/api/users?userId=${currentUserAccount.userId}`);
                if (response.ok) {
                    const userData = await response.json();
                    editFirstName.value = userData.firstName || '';
                    editLastName.value = userData.lastName || '';
                    editUsername.value = userData.username || '';
                    editEmail.value = userData.email || '';
                    editPhone.value = userData.phone || '';
                } else {
                    console.warn("Could not fetch user data for settings, using localStorage values.");
                    editFirstName.value = currentUserAccount.firstName || '';
                    editLastName.value = currentUserAccount.lastName || '';
                    editUsername.value = currentUserAccount.username || '';
                    editEmail.value = currentUserAccount.email || '';
                    editPhone.value = currentUserAccount.phone || '';
                }
            } catch (error) {
                console.error("Error fetching user data for settings:", error);
                editFirstName.value = currentUserAccount.firstName || '';
                editLastName.value = currentUserAccount.lastName || '';
                editUsername.value = currentUserAccount.username || '';
                editEmail.value = currentUserAccount.email || '';
                editPhone.value = currentUserAccount.phone || '';
            }
        });

        // Event Listeners for Buttons to Open Modals
        if (editProfileButton) {
            editProfileButton.addEventListener('click', () => {
                if (editProfileModal) editProfileModal.classList.remove('hidden');
            });
        }

        if (changePasswordButton) {
            changePasswordButton.addEventListener('click', () => {
                if (changePasswordModal) changePasswordModal.classList.remove('hidden');
                // Clear password fields on open
                if (oldPassword) oldPassword.value = '';
                if (newPassword) newPassword.value = '';
                if (confirmNewPassword) confirmNewPassword.value = '';
            });
        }

        // Redirect to notifications page
        if (manageNotificationsButton) {
            manageNotificationsButton.addEventListener('click', () => {
                window.location.href = 'player_notifications.html';
            });
        }


        if (deleteAccountButton) {
            deleteAccountButton.addEventListener('click', () => {
                if (deleteAccountModal) deleteAccountModal.classList.remove('hidden');
            });
        }

        // Event Listeners for Cancel Buttons in Modals
        if (cancelEditProfile) {
            cancelEditProfile.addEventListener('click', () => {
                if (editProfileModal) editProfileModal.classList.add('hidden');
            });
        }
        if (cancelChangePassword) {
            cancelChangePassword.addEventListener('click', () => {
                if (changePasswordModal) changePasswordModal.classList.add('hidden');
            });
        }
        if (cancelDeleteAccount) {
            cancelDeleteAccount.addEventListener('click', () => {
                if (deleteAccountModal) deleteAccountModal.classList.add('hidden');
            });
        }

        // Form Submission Handlers
        if (editProfileForm) {
            editProfileForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentUserAccount) { showMessage("Erreur", "Non connecté."); return; }

                const updatedData = {
                    firstName: editFirstName?.value.trim(),
                    lastName: editLastName?.value.trim(),
                    username: editUsername?.value.trim(),
                    // email: editEmail.value.trim(), // Email cannot be changed directly via this API in this setup
                    phone: editPhone?.value.trim(),
                };

                try {
                    const response = await fetch('/api/user_settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUserAccount.userId, action: 'updateProfile', ...updatedData })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        showMessage("Succès", result.message);
                        // Update localStorage with new data
                        localStorage.setItem('iwUserAccount', JSON.stringify({ ...currentUserAccount, ...updatedData }));
                        if (editProfileModal) editProfileModal.classList.add('hidden');
                        // No need to reload page, but could refresh data for consistency
                    } else {
                        showMessage("Erreur de Mise à Jour", result.message || "Erreur lors de la mise à jour du profil.");
                    }
                } catch (error) {
                    console.error("Erreur réseau lors de la mise à jour du profil:", error);
                    showMessage("Erreur Réseau", "Impossible de communiquer avec le serveur.");
                }
            });
        }

        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentUserAccount) { showMessage("Erreur", "Non connecté."); return; }

                const oldPass = oldPassword?.value;
                const newPass = newPassword?.value;
                const confirmNewPass = confirmNewPassword?.value;

                if (newPass !== confirmNewPass) {
                    showMessage("Erreur", "Les nouveaux mots de passe ne correspondent pas.");
                    return;
                }
                if (newPass.length < 6) {
                    showMessage("Erreur", "Le nouveau mot de passe doit contenir au moins 6 caractères.");
                    return;
                }

                try {
                    // IMPORTANT: Firebase Authentication signInWithEmailAndPassword (pour ré-authentifier)
                    // puis user.updatePassword() DOIT être utilisé ici pour une VRAIE sécurité.
                    // L'implémentation actuelle utilise une API backend simplifiée.
                    const response = await fetch('/api/user_settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUserAccount.userId, action: 'changePassword', oldPassword: oldPass, newPassword: newPass })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        showMessage("Succès", result.message);
                        if (changePasswordModal) changePasswordModal.classList.add('hidden');
                    } else {
                        showMessage("Erreur de Mot de Passe", result.message || "Erreur lors du changement de mot de passe.");
                    }
                } catch (error) {
                    console.error("Erreur réseau lors du changement de mot de passe:", error);
                    showMessage("Erreur Réseau", "Impossible de communiquer avec le serveur.");
                }
            });
        }

        if (confirmDeleteAccount) {
            confirmDeleteAccount.addEventListener('click', async () => {
                if (!currentUserAccount) { showMessage("Erreur", "Non connecté."); return; }

                try {
                    // This API call on the backend should trigger Firebase Admin SDK's deleteUser
                    const response = await fetch(`/api/user_settings?userId=${currentUserAccount.userId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        // In a real app, send authentication token for user to prove identity
                    });
                    const result = await response.json();

                    if (response.ok) {
                        showMessage("Compte Supprimé", result.message + " Redirection vers la page d'inscription...");
                        localStorage.removeItem('iwUserAccount'); // Clear local session
                        if (deleteAccountModal) deleteAccountModal.classList.add('hidden');
                        setTimeout(() => {
                            window.location.href = 'register.html'; // Redirect to register
                        }, 1500);
                    } else {
                        showMessage("Erreur de Suppression", result.message || "Erreur lors de la suppression du compte.");
                    }
                } catch (error) {
                    console.error("Erreur réseau lors de la suppression du compte:", error);
                    showMessage("Erreur Réseau", "Impossible de communiquer avec le serveur.");
                }
            });
        }
    </script>
</body>
</html>